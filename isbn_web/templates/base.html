<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ISBN Lot Optimizer{% endblock %}</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/favicon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/images/favicon-16.png">
    <link rel="manifest" href="/static/images/site.webmanifest">
    <link rel="shortcut icon" href="/static/images/favicon.ico">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Three.js (load before Alpine to avoid proxy conflicts) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/custom.css">

    <style>
        /* Custom styles for better UX */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-request.htmx-indicator {
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto px-4 py-2 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <h1 class="text-lg font-bold text-gray-900">ðŸ“š ISBN Lot Optimizer</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="/api/docs" target="_blank" class="text-xs text-gray-600 hover:text-gray-900">API Docs</a>
                    <button class="text-xs text-gray-600 hover:text-gray-900">Settings</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-screen-2xl mx-auto px-4 py-3 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Status Bar -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
        <div class="max-w-screen-2xl mx-auto px-4 py-1.5 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div id="status-message" class="text-xs text-gray-600">
                    Ready
                </div>
                <div class="flex items-center gap-6">
                    <div id="progress-bar" class="hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-48 bg-gray-200 rounded-full h-1.5">
                                <div id="progress-bar-fill" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="progress-text" class="text-xs text-gray-600">0%</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="book-count" class="text-xs text-gray-600">Loading...</span>
                        <span id="lot-count" class="text-xs text-gray-600 hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be inserted here dynamically -->
    </div>

    <!-- Custom JavaScript -->
    <script src="/static/js/carousel.js"></script>
    <script src="/static/js/app.js"></script>

    <!-- Alpine.js Carousel Component -->
    <script>
        function carouselData() {
            return {
                currentIndex: 0,
                isHovering: false,
                books: [],
                touchStartX: 0,
                touchEndX: 0,
                touchStartY: 0,
                isSwiping: false,
                navigate(index) { 
                    this.currentIndex = index; 
                },
                nextBook() { 
                    if (this.currentIndex < this.books.length - 1) this.currentIndex++; 
                },
                prevBook() { 
                    if (this.currentIndex > 0) this.currentIndex--; 
                },
                handleTouchStart(e) {
                    this.touchStartX = e.touches[0].clientX;
                    this.touchStartY = e.touches[0].clientY;
                    this.isSwiping = false;
                    console.log('Touch start:', this.touchStartX, this.touchStartY);
                },
                handleTouchMove(e) {
                    if (!this.touchStartX) return;
                    
                    const currentX = e.touches[0].clientX;
                    const currentY = e.touches[0].clientY;
                    const diffX = Math.abs(currentX - this.touchStartX);
                    const diffY = Math.abs(currentY - this.touchStartY);
                    
                    // If horizontal movement is greater than vertical, it's a swipe
                    if (diffX > diffY && diffX > 10) {
                        this.isSwiping = true;
                        e.preventDefault(); // Prevent scrolling
                    }
                },
                handleTouchEnd(e) {
                    if (!this.touchStartX) return;
                    
                    this.touchEndX = e.changedTouches[0].clientX;
                    console.log('Touch end:', this.touchEndX, 'isSwiping:', this.isSwiping);
                    
                    if (this.isSwiping) {
                        this.handleSwipe();
                    }
                    
                    // Reset
                    this.touchStartX = 0;
                    this.touchEndX = 0;
                    this.isSwiping = false;
                },
                handleSwipe() {
                    const swipeThreshold = 50;
                    const diff = this.touchStartX - this.touchEndX;
                    
                    console.log('Swipe diff:', diff, 'threshold:', swipeThreshold);
                    
                    if (Math.abs(diff) > swipeThreshold) {
                        if (diff > 0) {
                            // Swipe left - next book
                            console.log('Swipe left - next book');
                            this.nextBook();
                        } else {
                            // Swipe right - previous book
                            console.log('Swipe right - previous book');
                            this.prevBook();
                        }
                    }
                },
                getBookStyle(index) {
                    const diff = index - this.currentIndex;
                    const absDiff = Math.abs(diff);
                    
                    // Mobile-optimized transforms (reduced complexity)
                    const isMobile = window.innerWidth < 640;
                    const angle = isMobile ? diff * 8 : diff * 15;           // degrees rotation (reduced for mobile)
                    const distance = isMobile ? absDiff * 60 : absDiff * 120;    // horizontal spacing (reduced for mobile)
                    const depth = isMobile ? absDiff * 40 : absDiff * 100;       // z-axis depth (reduced for mobile)
                    const verticalOffset = isMobile ? 0 : absDiff * 20; // no upward arc on mobile
                    
                    const scale = Math.max(0.4, 1 - absDiff * 0.2);
                    const opacity = Math.max(0.2, 1 - absDiff * 0.3);
                    const blur = isMobile ? (absDiff > 0 ? absDiff * 1 : 0) : (absDiff > 0 ? absDiff * 2 : 0);
                    
                    // Debug logging for mobile
                    if (isMobile && index === this.currentIndex) {
                        console.log('Mobile book style:', { diff, absDiff, angle, distance, depth, verticalOffset });
                    }
                    
                    return {
                        transform: `translate3d(${diff * distance}px, ${verticalOffset}px, ${-depth}px) rotateY(${-angle}deg) scale(${scale})`,
                        opacity: opacity,
                        filter: `blur(${blur}px)`,
                        zIndex: 100 - absDiff
                    };
                },
                get currentBook() { 
                    return this.books[this.currentIndex]; 
                }
            }
        }
    </script>

    <!-- Global HTMX event handlers for carousel cleanup -->
    <script>
        // Clean up Three.js carousel before HTMX swaps new content
        document.body.addEventListener('htmx:beforeSwap', function(evt) {
            // Check if the target contains a carousel
            const target = evt.detail.target;
            if (target) {
                const carousel = target.querySelector('#carousel-container');
                if (carousel && carousel.__x) {
                    // Alpine component exists, call destroy
                    try {
                        const alpineData = Alpine.$data(carousel);
                        if (alpineData && typeof alpineData.destroy === 'function') {
                            console.log('Cleaning up carousel before HTMX swap');
                            alpineData.destroy();
                        }
                    } catch (e) {
                        console.warn('Error cleaning up carousel:', e);
                    }
                }
            }
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
