{% if book %}
<div class="flex h-full gap-3">
    <!-- Left: Cover Image -->
    <div class="flex-shrink-0 w-32">
        {% if book.metadata and book.metadata.cover_url %}
        <img src="{{ book.metadata.cover_url }}"
             alt="{{ book.metadata.title }}"
             class="w-full h-auto rounded shadow-md"
             onerror="this.style.display='none'">
        {% else %}
        <div class="w-full aspect-[2/3] bg-gradient-to-br from-blue-100 to-purple-100 rounded shadow-md flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        </div>
        {% endif %}
    </div>

    <!-- Right: Book Details -->
    <div class="flex-1 flex flex-col overflow-y-auto min-w-0">
        <!-- Title and Author -->
        <div class="mb-2 flex-shrink-0">
            <h3 class="text-sm font-semibold text-gray-900 leading-tight line-clamp-2">{{ book.metadata.title if book.metadata else 'Unknown Title' }}</h3>
            <p class="text-xs text-gray-600 mt-0.5 truncate">{{ book.metadata.authors|join(', ') if book.metadata and book.metadata.authors else 'Unknown Author' }}</p>
        </div>

        <!-- Two Column Layout - Essential Info Only -->
        <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-xs mb-1.5 flex-shrink-0">
            <!-- Column 1: Identification -->
            <div class="space-y-1">
            <div>
                <span class="text-gray-500 block">ISBN</span>
                <span class="font-medium text-gray-900">{{ book.isbn }}</span>
            </div>

            <div>
                <span class="text-gray-500 block">Condition</span>
                <span class="font-medium text-gray-900">{{ book.condition or 'N/A' }}</span>
            </div>

            {% if book.metadata and book.metadata.published_year %}
            <div>
                <span class="text-gray-500 block">Published</span>
                <span class="font-medium text-gray-900">{{ book.metadata.published_year }}</span>
            </div>
            {% endif %}

            {% if book.edition %}
            <div>
                <span class="text-gray-500 block">Edition</span>
                <span class="font-medium text-gray-900">{{ book.edition }}</span>
            </div>
            {% endif %}
        </div>

            <!-- Column 2: Pricing & Probability -->
            <div class="space-y-1">
            {% if book.estimated_price %}
            <div>
                <span class="text-gray-500 block">Est. Price</span>
                <span class="font-semibold text-green-600">${{ "%.2f"|format(book.estimated_price) }}</span>
            </div>
            {% endif %}

            {% if book.probability_label %}
            <div>
                <span class="text-gray-500 block">Probability</span>
                <div class="flex items-center gap-1">
                    {% if book.probability_label == 'Excellent' %}
                        <span class="badge badge-success">{{ book.probability_label }}</span>
                    {% elif book.probability_label == 'Good' %}
                        <span class="badge badge-info">{{ book.probability_label }}</span>
                    {% elif book.probability_label == 'Fair' %}
                        <span class="badge badge-warning">{{ book.probability_label }}</span>
                    {% else %}
                        <span class="badge badge-danger">{{ book.probability_label }}</span>
                    {% endif %}
                    {% if book.probability_score %}
                        <span class="text-xs text-gray-500">{{ "%.0f"|format(book.probability_score * 100) }}%</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if book.rarity %}
            <div>
                <span class="text-gray-500 block">Rarity</span>
                <span class="font-medium text-gray-900">{{ "%.1f"|format(book.rarity) }}</span>
            </div>
            {% endif %}

            {% if book.bookscouter and book.bookscouter.total_vendors > 0 %}
            <div>
                <span class="text-gray-500 block">Buyback</span>
                <span class="font-semibold text-blue-600">${{ "%.2f"|format(book.bookscouter.best_price) }}</span>
                <div class="text-xs text-gray-400">{{ book.bookscouter.total_vendors }} vendors</div>
            </div>
            {% endif %}
        </div>
        </div>

        <!-- BookScouter Details - Collapsible -->
        {% if book.bookscouter and book.bookscouter.total_vendors > 0 %}
        <details class="text-xs flex-shrink-0 mb-1.5">
            <summary class="text-gray-500 cursor-pointer hover:text-gray-700 font-medium text-[11px]">Top Buyback Offers</summary>
            <div class="space-y-0.5 mt-1">
                {% for offer in book.bookscouter.offers[:3] %}
                <div class="flex justify-between items-center py-0.5">
                    <span class="text-gray-700 text-[11px]">{{ offer.vendor_name }}</span>
                    <span class="font-medium text-blue-600 text-[11px]">${{ "%.2f"|format(offer.price) }}</span>
                </div>
                {% endfor %}
            </div>
        </details>
        {% endif %}

        <!-- eBay Sold Comps - Expanded by default -->
        {% if book.market and book.market.sold_comps_count and book.market.sold_comps_count > 0 %}
        <details open class="text-xs flex-shrink-0 mb-1.5">
            <summary class="text-gray-500 cursor-pointer hover:text-gray-700 font-medium text-[11px]">
                eBay Sold Comps ({{ book.market.sold_comps_count }})
                {% if book.market.sold_comps_is_estimate %}
                <span class="text-[10px] text-gray-400">(est)</span>
                {% endif %}
            </summary>
            <div class="space-y-1 mt-1">
                <div class="grid grid-cols-3 gap-x-2">
                    <div>
                        <span class="text-gray-500 block text-[10px]">Min</span>
                        <span class="font-semibold text-blue-600">${{ "%.2f"|format(book.market.sold_comps_min) }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500 block text-[10px]">Median</span>
                        <span class="font-semibold text-blue-600">${{ "%.2f"|format(book.market.sold_comps_median) }}</span>
                    </div>
                    <div>
                        <span class="text-gray-500 block text-[10px]">Max</span>
                        <span class="font-semibold text-blue-600">${{ "%.2f"|format(book.market.sold_comps_max) }}</span>
                    </div>
                </div>
                {% if book.market.sold_comps_last_sold_date %}
                <div class="text-[10px] text-gray-500 mt-1">
                    Last sold: {{ book.market.sold_comps_last_sold_date[:10] }}
                </div>
                {% endif %}
            </div>
        </details>
        {% endif %}

        <!-- Series Information - BookSeries.org -->
        {% if book.metadata and book.metadata.raw and book.metadata.raw.get('bookseries_org') %}
        {% set series_info = book.metadata.raw.bookseries_org %}
        <details open class="text-xs flex-shrink-0 mb-1.5 border border-purple-200 rounded p-1.5 bg-purple-50">
            <summary class="text-purple-700 cursor-pointer hover:text-purple-900 font-semibold text-[11px]">
                ðŸ“š Series: {{ series_info.series_title }}
            </summary>
            <div class="mt-1.5 space-y-1">
                <div class="flex justify-between text-[11px]">
                    <span class="text-gray-600">Author:</span>
                    <span class="font-medium text-gray-900">{{ series_info.author_name }}</span>
                </div>
                <div class="flex justify-between text-[11px]">
                    <span class="text-gray-600">Books in Series:</span>
                    <span class="font-medium text-gray-900">{{ series_info.book_count }}</span>
                </div>
                <div class="flex justify-between text-[11px]">
                    <span class="text-gray-600">Match Confidence:</span>
                    <span class="font-medium text-green-600">{{ "%.0f"|format(series_info.confidence * 100) }}%</span>
                </div>
                {% if series_info.books %}
                <div class="mt-2 pt-1 border-t border-purple-200">
                    <div class="text-[10px] text-gray-500 mb-1">Complete Series:</div>
                    <div class="max-h-24 overflow-y-auto space-y-0.5">
                        {% for book_title in series_info.books[:10] %}
                        <div class="text-[10px] text-gray-700 pl-2">{{ loop.index }}. {{ book_title }}</div>
                        {% endfor %}
                        {% if series_info.books|length > 10 %}
                        <div class="text-[10px] text-gray-500 pl-2 italic">... and {{ series_info.books|length - 10 }} more</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </details>
        {% endif %}

        <!-- Market Stats - Collapsible -->
        <details class="text-xs flex-shrink-0 mb-1.5">
            <summary class="text-gray-500 cursor-pointer hover:text-gray-700 font-medium text-[11px]">Market Stats</summary>
            <div class="grid grid-cols-2 gap-x-2 gap-y-1 mt-1">
            {% if book.market and book.market.active_count is not none %}
            <div>
                <span class="text-gray-500 block">Active Listings</span>
                <span class="font-medium text-gray-900">{{ book.market.active_count }}</span>
            </div>
            {% endif %}

            {% if book.market and book.market.sold_count is not none %}
            <div>
                <span class="text-gray-500 block">Recently Sold</span>
                <span class="font-medium text-gray-900">{{ book.market.sold_count }}</span>
            </div>
            {% endif %}

            {% if book.market and book.market.sell_through_rate is not none %}
            <div>
                <span class="text-gray-500 block">Sell-Through</span>
                <span class="font-medium text-gray-900">{{ "%.0f"|format(book.market.sell_through_rate * 100) }}%</span>
            </div>
            {% endif %}

            {% if book.metadata and book.metadata.series_name %}
            <div>
                <span class="text-gray-500 block">Series</span>
                <div>
                    <span class="font-medium text-gray-900">{{ book.metadata.series_name }}</span>
                    {% if book.metadata.series_index %}
                        <span class="text-xs text-gray-500">#{{ book.metadata.series_index }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        </details>

        <!-- Profit Calculator -->
        <div x-data="{
            purchasePrice: 0,
            get salePrice() {
                {% if book.market and book.market.sold_comps_median %}
                return {{ book.market.sold_comps_median }};
                {% elif book.estimated_price %}
                return {{ book.estimated_price }};
                {% else %}
                return 0;
                {% endif %}
            },
            get ebayFees() {
                const feeRate = 0.1325; // 13.25% for books
                const transactionFee = 0.30;
                return (this.salePrice * feeRate) + transactionFee;
            },
            get netProceeds() {
                return this.salePrice - this.ebayFees;
            },
            get profit() {
                return this.netProceeds - this.purchasePrice;
            },
            get buybackProfit() {
                {% if book.bookscouter and book.bookscouter.best_price %}
                return {{ book.bookscouter.best_price }} - this.purchasePrice;
                {% else %}
                return 0;
                {% endif %}
            }
        }" class="text-xs flex-shrink-0 mb-1.5 p-2 bg-gray-50 rounded border border-gray-200">
            <div class="flex items-center gap-1 mb-2">
                <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="font-medium text-[11px] text-gray-700">Profit Calculator</span>
            </div>

            <!-- Purchase Price Input -->
            <div class="mb-2">
                <label class="text-[10px] text-gray-500 block mb-0.5">Purchase Price</label>
                <div class="flex items-center gap-1">
                    <span class="text-[11px] text-gray-500">$</span>
                    <input type="number"
                           x-model.number="purchasePrice"
                           step="0.01"
                           min="0"
                           class="flex-1 px-1.5 py-0.5 text-[11px] border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="0.00">
                </div>
            </div>

            <!-- eBay Profit Breakdown -->
            {% if book.market and book.market.sold_comps_median or book.estimated_price %}
            <div class="space-y-1 text-[10px]">
                <div class="flex justify-between text-gray-600">
                    <span>Sale Price (median)</span>
                    <span class="font-medium" x-text="'$' + salePrice.toFixed(2)"></span>
                </div>
                <div class="flex justify-between text-red-600">
                    <span>- eBay Fees (13.25% + $0.30)</span>
                    <span class="font-medium" x-text="'-$' + ebayFees.toFixed(2)"></span>
                </div>
                <div class="flex justify-between text-gray-600">
                    <span>- Purchase Cost</span>
                    <span class="font-medium" x-text="'-$' + purchasePrice.toFixed(2)"></span>
                </div>
                <div class="flex justify-between pt-1 border-t border-gray-300 font-semibold"
                     :class="profit > 0 ? 'text-green-600' : 'text-red-600'">
                    <span>Net Profit</span>
                    <span x-text="'$' + profit.toFixed(2)"></span>
                </div>
            </div>
            {% endif %}

            <!-- Buyback Alternative -->
            {% if book.bookscouter and book.bookscouter.best_price and book.bookscouter.best_price > 0 %}
            <div class="mt-2 pt-2 border-t border-gray-200 text-[10px]">
                <div class="flex justify-between text-gray-600">
                    <span>Buyback ({{ book.bookscouter.best_vendor }})</span>
                    <span class="font-semibold text-green-600">${{ "%.2f"|format(book.bookscouter.best_price) }}</span>
                </div>
                <div class="flex justify-between text-gray-600">
                    <span>- Purchase Cost</span>
                    <span class="font-medium" x-text="'-$' + purchasePrice.toFixed(2)"></span>
                </div>
                <div class="flex justify-between font-semibold text-green-600">
                    <span>Buyback Profit</span>
                    <span x-text="'$' + buybackProfit.toFixed(2)"></span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Actions - Compact -->
        <div class="mt-auto pt-1.5 border-t border-gray-200 flex-shrink-0 space-y-1">
            <button hx-post="/api/books/{{ book.isbn }}/refresh"
                    hx-target="#book-detail"
                    hx-swap="innerHTML"
                    hx-disabled-elt="this"
                    class="w-full px-2 py-1 text-[11px] font-medium text-white bg-green-600 rounded hover:bg-green-700 flex items-center justify-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-3 h-3 htmx-indicator animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Refresh Data</span>
            </button>
            <a href="https://www.ebay.com/sch/i.html?_nkw={{ book.isbn }}"
               target="_blank"
               class="block w-full px-2 py-1 text-[11px] font-medium text-center text-gray-700 bg-gray-100 rounded hover:bg-gray-200">
                Search eBay
            </a>
        </div>
    </div>
</div>

{% elif error %}
<div class="p-4 text-center">
    <p class="text-xs text-red-600">{{ error }}</p>
</div>

{% else %}
<div class="p-4 text-center">
    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
    <p class="mt-2 text-xs text-gray-500">Select a book to view details</p>
</div>
{% endif %}
