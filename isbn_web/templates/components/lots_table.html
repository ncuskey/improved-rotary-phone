<!-- Lots table component - must be wrapped in flex-1 overflow-auto container -->
<script id="lots-data" type="application/json">
{{ lots | tojson | safe }}
</script>
<div id="lots-table"
     x-data="{
       lots: [],
       sortColumn: null,
       sortDirection: 'asc',
       loadingLotId: null,
       filterVersion: 0,
       init() {
         const dataScript = document.getElementById('lots-data');
         if (dataScript) {
           this.lots = JSON.parse(dataScript.textContent);
         }

         // Watch the Alpine store for changes and trigger re-render
         this.$watch('$store.lotFilters', () => {
           this.filterVersion++;
         }, { deep: true });
       },
       sort(column) {
         if (this.sortColumn === column) {
           this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
         } else {
           this.sortColumn = column;
           this.sortDirection = 'asc';
         }
       },
       loadLot(event, lotId) {
         // Skip if clicking on a link
         if (event.target.tagName === 'A' || event.target.closest('a')) {
           return;
         }
         // Prevent duplicate calls
         if (this.loadingLotId === lotId) {
           return;
         }
         console.log('Loading lot:', lotId);
         this.loadingLotId = lotId;

         // Determine if this is the first load (carousel not yet initialized)
         const isFirstLoad = !window.threeState || !window.threeState.isInitialized;

         // Setup one-time event listener for carousel load completion
         const handleCarouselSwap = function() {
           console.log('Carousel HTML swapped, dispatching event...');
           // Give Alpine a moment to process the new HTML
           setTimeout(() => {
             if (isFirstLoad) {
               // First load - trigger init
               console.log('First load - dispatching carousel-init');
               window.dispatchEvent(new CustomEvent('carousel-init'));
             } else {
               // Subsequent load - trigger reload
               console.log('Subsequent load - dispatching carousel-reload');
               window.dispatchEvent(new CustomEvent('carousel-reload'));
             }
           }, 100);
           // Remove this listener after one use
           document.getElementById('lot-carousel-container').removeEventListener('htmx:afterSwap', handleCarouselSwap);
         };

         // Add event listener before making the request
         document.getElementById('lot-carousel-container').addEventListener('htmx:afterSwap', handleCarouselSwap);

         // Load carousel into top section
         htmx.ajax('GET', `/api/lots/${lotId}/carousel`, {
           target: '#lot-carousel-container',
           swap: 'innerHTML'
         });

         // Load details into side panel
         htmx.ajax('GET', `/api/lots/${lotId}`, {
           target: '#lot-detail',
           swap: 'innerHTML'
         });

         // Reset after a short delay
         setTimeout(() => { this.loadingLotId = null; }, 100);
       },
       get filteredLots() {
         // Reference filterVersion to ensure reactivity
         const _ = this.filterVersion;

         // Get filter state from Alpine store
         const filterState = Alpine.store('lotFilters') || {
           author: true,
           series_complete: true,
           series_partial: true,
           series_incomplete: true,
           series: true,
           genre: false,
           value: true
         };

         const filtered = this.lots.filter(lot => {
           const strategy = lot.strategy || '';

           // Direct strategy matching
           if (filterState[strategy] !== undefined) {
             return filterState[strategy] === true;
           }

           // Fallback for unknown strategies: hide
           return false;
         });

         // Debug logging
         if (this.lots.length > 0 && this.filterVersion < 5) {
           console.log('Filter state:', filterState);
           console.log(`Filtered ${this.lots.length} lots down to ${filtered.length}`);
           const strategies = [...new Set(filtered.map(l => l.strategy))];
           console.log('Strategies in filtered lots:', strategies);
         }

         return filtered;
       },
       get sortedLots() {
         const filtered = this.filteredLots;
         if (!this.sortColumn) return filtered;

         const sorted = [...filtered].sort((a, b) => {
           let aVal, bVal;

           switch(this.sortColumn) {
             case 'name':
               aVal = a.name || '';
               bVal = b.name || '';
               break;
             case 'strategy':
               aVal = a.strategy || '';
               bVal = b.strategy || '';
               break;
             case 'books':
               aVal = Array.isArray(a.book_isbns) ? a.book_isbns.length : 0;
               bVal = Array.isArray(b.book_isbns) ? b.book_isbns.length : 0;
               break;
             case 'value':
               aVal = a.estimated_value || 0;
               bVal = b.estimated_value || 0;
               break;
             case 'probability':
               aVal = a.probability_score || 0;
               bVal = b.probability_score || 0;
               break;
             case 'sellthrough':
               aVal = a.sell_through || 0;
               bVal = b.sell_through || 0;
               break;
             default:
               return 0;
           }

           if (typeof aVal === 'string') {
             return this.sortDirection === 'asc'
               ? aVal.localeCompare(bVal)
               : bVal.localeCompare(aVal);
           } else {
             return this.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
           }
         });

         return sorted;
       }
     }">
    <table class="w-full divide-y divide-gray-200" x-show="sortedLots.length > 0">
        <thead class="bg-gray-50 sticky top-0 z-10">
            <tr>
                <th scope="col" @click="sort('name')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Name</span>
                        <svg x-show="sortColumn === 'name'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
                <th scope="col" @click="sort('strategy')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Strategy</span>
                        <svg x-show="sortColumn === 'strategy'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
                <th scope="col" @click="sort('books')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Books</span>
                        <svg x-show="sortColumn === 'books'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
                <th scope="col" @click="sort('value')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Est. Value</span>
                        <svg x-show="sortColumn === 'value'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
                <th scope="col" @click="sort('probability')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Probability</span>
                        <svg x-show="sortColumn === 'probability'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
                <th scope="col" @click="sort('sellthrough')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap cursor-pointer hover:bg-gray-100 select-none">
                    <div class="flex items-center gap-1">
                        <span>Sell-Through</span>
                        <svg x-show="sortColumn === 'sellthrough'" class="w-4 h-4" :class="sortDirection === 'desc' ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                        </svg>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="lot in sortedLots" :key="lot.id">
                <tr class="table-row hover:bg-gray-50"
                    @click="loadLot($event, lot.id)">
                    <td class="px-4 py-3 text-sm text-gray-900">
                        <div class="flex items-center gap-2">
                            <div class="font-medium truncate max-w-xs" :title="lot.name" x-text="lot.name"></div>
                            <a :href="`/api/lots/${lot.id}/details`"
                               @click.stop
                               class="inline-flex items-center px-2 py-1 text-xs text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded transition-colors"
                               title="View in 3D Carousel">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </a>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800" x-text="lot.strategy"></span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 text-center">
                        <span x-text="Array.isArray(lot.book_isbns) ? lot.book_isbns.length : 0"></span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <template x-if="lot.estimated_value">
                            <span class="font-semibold text-green-600" x-text="'$' + lot.estimated_value.toFixed(2)"></span>
                        </template>
                        <template x-if="!lot.estimated_value">
                            <span class="text-gray-400">—</span>
                        </template>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <template x-if="lot.probability_label">
                            <div>
                                <span :class="{
                                    'badge badge-success': lot.probability_label === 'Excellent',
                                    'badge badge-info': lot.probability_label === 'Good',
                                    'badge badge-warning': lot.probability_label === 'Fair',
                                    'badge badge-danger': lot.probability_label !== 'Excellent' && lot.probability_label !== 'Good' && lot.probability_label !== 'Fair'
                                }" x-text="lot.probability_label"></span>
                                <span x-show="lot.probability_score" class="text-xs text-gray-500 ml-1" x-text="Math.round(lot.probability_score * 100) + '%'"></span>
                            </div>
                        </template>
                        <template x-if="!lot.probability_label">
                            <span class="text-gray-400">—</span>
                        </template>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        <template x-if="lot.sell_through !== null && lot.sell_through !== undefined">
                            <span x-text="Math.round(lot.sell_through * 100) + '%'"></span>
                        </template>
                        <template x-if="lot.sell_through === null || lot.sell_through === undefined">
                            <span class="text-gray-400">—</span>
                        </template>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <div x-show="sortedLots.length === 0" class="flex items-center justify-center p-8">
        <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No lots found</h3>
            <p class="mt-1 text-sm text-gray-500">Scan some books to generate lot recommendations.</p>
            <div class="mt-4">
                <button hx-post="/api/lots/regenerate"
                        hx-target="#lots-table"
                        hx-swap="outerHTML"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Generate Lots
                </button>
            </div>
        </div>
    </div>
</div>
